

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="presbyter">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. 服务注册与动态配置（Nacos）使用场景在微服务架构的电商平台中，各服务模块（如用户服务、订单服务、商品服务等）需要高效地发现彼此并进行通信。同时，为了应对高并发请求，需要对服务进行负载均衡，避免某些服务实例过载。此外，配置信息（如数据库连接、服务超时时间等）需要动态更新，而无需重启服务。Nacos作为服务注册与配置管理工具，结合OpenFeign和Ribbon，能够很好地满足这些需求。">
<meta property="og:type" content="article">
<meta property="og:title" content="天天商城随记">
<meta property="og:url" content="http://example.com/2025/03/09/%E5%A4%A9%E5%A4%A9%E5%95%86%E5%9F%8E%E9%9A%8F%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. 服务注册与动态配置（Nacos）使用场景在微服务架构的电商平台中，各服务模块（如用户服务、订单服务、商品服务等）需要高效地发现彼此并进行通信。同时，为了应对高并发请求，需要对服务进行负载均衡，避免某些服务实例过载。此外，配置信息（如数据库连接、服务超时时间等）需要动态更新，而无需重启服务。Nacos作为服务注册与配置管理工具，结合OpenFeign和Ribbon，能够很好地满足这些需求。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-09T01:51:02.000Z">
<meta property="article:modified_time" content="2025-03-19T01:47:39.135Z">
<meta property="article:author" content="presbyter">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>天天商城随记 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="天天商城随记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-09 09:51" pubdate>
          2025年3月9日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          73 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">天天商城随记</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-服务注册与动态配置（Nacos）"><a href="#1-服务注册与动态配置（Nacos）" class="headerlink" title="1. 服务注册与动态配置（Nacos）"></a><strong>1. 服务注册与动态配置（Nacos）</strong></h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>在微服务架构的电商平台中，各服务模块（如用户服务、订单服务、商品服务等）需要高效地发现彼此并进行通信。同时，为了应对高并发请求，需要对服务进行负载均衡，避免某些服务实例过载。此外，配置信息（如数据库连接、服务超时时间等）需要动态更新，而无需重启服务。Nacos作为服务注册与配置管理工具，结合OpenFeign和Ribbon，能够很好地满足这些需求。</p>
<hr>
<h3 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-服务注册与动态配置管理"><a href="#1-服务注册与动态配置管理" class="headerlink" title="1. 服务注册与动态配置管理"></a>1. <strong>服务注册与动态配置管理</strong></h4><p><strong>技术选型：</strong> 使用Nacos作为服务注册中心和配置管理工具。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>引入Nacos依赖</strong><br>在<code>pom.xml</code>文件中引入Nacos客户端依赖，用于服务注册与发现以及配置管理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Nacos服务注册</strong><br>在<code>application.yml</code>文件中配置Nacos服务器地址，使微服务能够注册到Nacos：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">your-service-name</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>动态配置管理</strong><br>在Nacos控制台中创建配置文件，例如<code>your-service-name.yaml</code>，并添加配置内容（如数据库连接信息等）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/your_db_name</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span><br></code></pre></td></tr></table></figure>

<p>在微服务中通过<code>@Value</code>注解动态读取配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String dbUrl;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDbUrl</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> dbUrl;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当Nacos中的配置发生变化时，微服务会自动更新配置，无需重启。</p>
</li>
</ul>
<h4 id="2-服务间通信与负载均衡"><a href="#2-服务间通信与负载均衡" class="headerlink" title="2. 服务间通信与负载均衡"></a>2. <strong>服务间通信与负载均衡</strong></h4><p><strong>技术选型：</strong> 使用OpenFeign进行服务间通信，结合Ribbon实现负载均衡。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>引入OpenFeign依赖</strong><br>在<code>pom.xml</code>文件中引入OpenFeign依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>启用Feign客户端</strong><br>在Spring Boot应用主类上添加<code>@EnableFeignClients</code>注解，启用Feign客户端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YourServiceApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(YourServiceApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>定义Feign客户端接口</strong><br>创建一个Feign客户端接口，用于定义服务间通信的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;user-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/users/&#123;id&#125;&quot;)</span><br>    User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Ribbon负载均衡策略</strong><br>在<code>application.yml</code>文件中配置Ribbon的负载均衡策略，例如使用轮询策略：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RoundRobinRule</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>调用服务接口</strong><br>在业务逻辑中通过Feign客户端调用其他服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserClient userClient;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userClient.getUserById(userId);<br>        <span class="hljs-comment">// 处理订单逻辑</span><br>        System.out.println(<span class="hljs-string">&quot;User: &quot;</span> + user.getName() + <span class="hljs-string">&quot; created an order.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当调用<code>userClient.getUserById(userId)</code>时，OpenFeign会通过Ribbon从Nacos获取<code>user-service</code>的实例列表，并根据配置的负载均衡策略（轮询）选择一个实例进行通信。</p>
</li>
</ul>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>服务注册与发现</strong>：微服务自动注册到Nacos，并能够动态发现其他服务。</li>
<li><strong>动态配置管理</strong>：配置信息存储在Nacos中，微服务能够动态读取并更新配置，无需重启。</li>
<li><strong>服务间通信与负载均衡</strong>：通过OpenFeign实现服务间通信，结合Ribbon实现负载均衡，提高系统的高可用性和性能。</li>
</ol>
<h2 id="2-服务保护与熔断降级（Sentinel）"><a href="#2-服务保护与熔断降级（Sentinel）" class="headerlink" title="2. 服务保护与熔断降级（Sentinel）"></a><strong>2. 服务保护与熔断降级（Sentinel）</strong></h2><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><p>在高并发的电商平台中，某些热点接口（如商品查询接口）可能会因为流量过高而导致服务过载甚至崩溃。此外，当服务调用链路中的某个环节出现故障时，如果不加以控制，可能会导致整个服务链路的不可用。为了保障系统的稳定性和可靠性，需要对服务进行熔断和限流。Sentinel作为阿里巴巴开源的流量控制和熔断降级框架，能够很好地满足这些需求，通过配置QPS阈值、线程隔离和熔断规则，确保系统在高并发场景下的稳定运行。</p>
<hr>
<h3 id="实现方法-1"><a href="#实现方法-1" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-集成Sentinel"><a href="#1-集成Sentinel" class="headerlink" title="1. 集成Sentinel"></a>1. <strong>集成Sentinel</strong></h4><p><strong>技术选型：</strong> 使用阿里巴巴的Sentinel框架进行服务熔断和限流。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>引入Sentinel依赖</strong><br>在<code>pom.xml</code>文件中引入Sentinel的Spring Cloud集成依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Sentinel控制台</strong><br>在<code>application.yml</code>文件中配置Sentinel控制台地址，方便进行规则配置和监控：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-配置QPS限流规则"><a href="#2-配置QPS限流规则" class="headerlink" title="2. 配置QPS限流规则"></a>2. <strong>配置QPS限流规则</strong></h4><p><strong>使用场景：</strong> 对商品查询接口进行限流，防止流量过高导致服务过载。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>定义限流规则</strong><br>在Sentinel控制台中为商品查询接口配置QPS限流规则，设置QPS阈值为500。当接口的访问频率超过500次&#x2F;秒时，触发限流。</p>
</li>
<li><p><strong>代码实现</strong><br>在商品查询接口的Controller中添加Sentinel注解<code>@SentinelResource</code>，指定资源名称和限流策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/products&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductService productService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;productQuery&quot;, blockHandler = &quot;handleQueryLimit&quot;)</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> productService.getProductById(id);<br>    &#125;<br><br>    <span class="hljs-comment">// 限流降级处理方法</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">handleQueryLimit</span><span class="hljs-params">(Long id, BlockException ex)</span> &#123;<br>        <span class="hljs-comment">// 返回降级后的结果，例如返回一个默认的商品信息或提示信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;Product is under high traffic, please try again later.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-线程隔离与熔断规则"><a href="#3-线程隔离与熔断规则" class="headerlink" title="3. 线程隔离与熔断规则"></a>3. <strong>线程隔离与熔断规则</strong></h4><p><strong>使用场景：</strong> 对库存扣减接口进行线程隔离和熔断保护，防止资源耗尽和故障传播。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>配置线程池</strong><br>在Sentinel控制台中为库存扣减接口配置线程池隔离规则，设置最大并发线程数为50。当并发线程数超过50时，触发线程隔离。</p>
</li>
<li><p><strong>配置熔断规则</strong><br>在Sentinel控制台中为库存扣减接口配置熔断规则，设置错误比例阈值为50%。当接口的错误比例超过50%时，触发熔断，进入降级逻辑。</p>
</li>
<li><p><strong>代码实现</strong><br>在库存扣减接口的Controller中添加Sentinel注解<code>@SentinelResource</code>，指定资源名称和熔断策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/inventory&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InventoryService inventoryService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/deduct&quot;)</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;inventoryDeduct&quot;, blockHandler = &quot;handleDeductLimit&quot;, fallback = &quot;handleDeductFallback&quot;)</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> InventoryRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> inventoryService.deductInventory(request);<br>    &#125;<br><br>    <span class="hljs-comment">// 限流降级处理方法</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">handleDeductLimit</span><span class="hljs-params">(InventoryRequest request, BlockException ex)</span> &#123;<br>        <span class="hljs-comment">// 返回降级后的结果，例如返回false表示扣减失败</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 熔断降级处理方法</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">handleDeductFallback</span><span class="hljs-params">(InventoryRequest request, Throwable ex)</span> &#123;<br>        <span class="hljs-comment">// 返回降级后的结果，例如返回false表示扣减失败</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-Feign-FallbackFactory实现降级逻辑"><a href="#4-Feign-FallbackFactory实现降级逻辑" class="headerlink" title="4. Feign FallbackFactory实现降级逻辑"></a>4. <strong>Feign FallbackFactory实现降级逻辑</strong></h4><p><strong>使用场景：</strong> 当服务调用失败时，通过Feign的FallbackFactory机制提供降级逻辑，避免故障传播。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>定义FallbackFactory</strong><br>创建一个FallbackFactory类，实现<code>FallbackFactory</code>接口，定义降级逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryServiceFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;InventoryService&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> InventoryService <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable cause)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryService</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(InventoryRequest request)</span> &#123;<br>                <span class="hljs-comment">// 返回降级后的结果，例如返回false表示扣减失败</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Feign客户端的FallbackFactory</strong><br>在Feign客户端接口中指定FallbackFactory：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;inventory-service&quot;, fallbackFactory = InventoryServiceFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryService</span> &#123;<br>    <span class="hljs-meta">@PostMapping(&quot;/inventory/deduct&quot;)</span><br>    Boolean <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> InventoryRequest request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>QPS限流</strong>：对商品查询接口进行限流，防止流量过高导致服务过载。</li>
<li><strong>线程隔离</strong>：对库存扣减接口进行线程隔离，限制并发线程数，避免资源耗尽。</li>
<li><strong>熔断保护</strong>：当库存扣减接口的错误比例超过50%时，触发熔断，进入降级逻辑。</li>
<li><strong>降级逻辑</strong>：通过Feign的FallbackFactory机制，在服务调用失败时提供降级逻辑，避免故障传播。</li>
</ol>
<h2 id="3-订单超时与库存回滚（RabbitMQ）"><a href="#3-订单超时与库存回滚（RabbitMQ）" class="headerlink" title="3. 订单超时与库存回滚（RabbitMQ）"></a><strong>3. 订单超时与库存回滚（RabbitMQ）</strong></h2><h3 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h3><p>在电商平台中，用户下单后需要在一定时间内完成支付。如果用户在规定时间内未支付订单，系统需要自动关闭订单，并将占用的库存释放回商品池中。此外，为了确保消息的可靠传递，需要使用消息队列的确认机制来保证消息不会丢失。RabbitMQ的延迟队列和死信队列功能可以很好地实现这一需求，同时通过生产者确认机制和消费者手动ACK来保障消息的可靠性。</p>
<hr>
<h3 id="实现方法-2"><a href="#实现方法-2" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-引入RabbitMQ依赖"><a href="#1-引入RabbitMQ依赖" class="headerlink" title="1. 引入RabbitMQ依赖"></a>1. <strong>引入RabbitMQ依赖</strong></h4><p><strong>技术选型：</strong> 使用RabbitMQ作为消息中间件。</p>
<p><strong>具体实现：</strong><br>在<code>pom.xml</code>文件中引入RabbitMQ的Spring Boot Starter依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-配置RabbitMQ"><a href="#2-配置RabbitMQ" class="headerlink" title="2. 配置RabbitMQ"></a>2. <strong>配置RabbitMQ</strong></h4><p><strong>具体实现：</strong><br>在<code>application.yml</code>文件中配置RabbitMQ的连接信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">publisher-confirms:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启生产者确认机制</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span>  <span class="hljs-comment"># 开启消费者手动ACK</span><br></code></pre></td></tr></table></figure>

<h4 id="3-创建延迟队列和死信队列"><a href="#3-创建延迟队列和死信队列" class="headerlink" title="3. 创建延迟队列和死信队列"></a>3. <strong>创建延迟队列和死信队列</strong></h4><p><strong>具体实现：</strong><br>定义一个配置类，创建延迟队列和死信队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br>    <span class="hljs-comment">// 延迟队列的交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DELAYED_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order.delayed.exchange&quot;</span>;<br>    <span class="hljs-comment">// 延迟队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DELAYED_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order.delayed.queue&quot;</span>;<br>    <span class="hljs-comment">// 死信队列的交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_LETTER_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order.dead.letter.exchange&quot;</span>;<br>    <span class="hljs-comment">// 死信队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_LETTER_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order.dead.letter.queue&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">delayedExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建一个延迟队列的交换机</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(DELAYED_EXCHANGE, <span class="hljs-string">&quot;x-delayed-message&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>,<br>                Collections.singletonMap(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayedQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建延迟队列</span><br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(DELAYED_QUEUE)<br>                .withArguments(Collections.singletonMap(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE))<br>                .build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">delayedBinding</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 将延迟队列绑定到延迟交换机</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayedExchange()).with(<span class="hljs-string">&quot;order.delayed.routing.key&quot;</span>).noargs();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadLetterQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建死信队列</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEAD_LETTER_QUEUE, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">deadLetterExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建死信队列的交换机</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DEAD_LETTER_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">deadLetterBinding</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 将死信队列绑定到死信交换机</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadLetterQueue()).to(deadLetterExchange()).with(<span class="hljs-string">&quot;order.dead.letter.routing.key&quot;</span>).noargs();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-发送延迟消息"><a href="#4-发送延迟消息" class="headerlink" title="4. 发送延迟消息"></a>4. <strong>发送延迟消息</strong></h4><p><strong>具体实现：</strong><br>在订单服务中，当用户下单成功后，发送一个延迟消息到延迟队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> &#123;<br>        <span class="hljs-comment">// 创建订单逻辑</span><br>        System.out.println(<span class="hljs-string">&quot;Order created: &quot;</span> + order.getId());<br><br>        <span class="hljs-comment">// 发送延迟消息</span><br>        rabbitTemplate.convertAndSend(RabbitMQConfig.DELAYED_EXCHANGE, <span class="hljs-string">&quot;order.delayed.routing.key&quot;</span>, order, m -&gt; &#123;<br>            m.getMessageProperties().setDelay(<span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 设置延迟时间为30分钟</span><br>            <span class="hljs-keyword">return</span> m;<br>        &#125;);<br><br>        <span class="hljs-comment">// 确认消息发送成功</span><br>        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (!ack) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Message send failed: &quot;</span> + cause);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-处理死信消息"><a href="#5-处理死信消息" class="headerlink" title="5. 处理死信消息"></a>5. <strong>处理死信消息</strong></h4><p><strong>具体实现：</strong><br>在消费者中处理死信队列中的消息，触发订单关闭和库存回滚：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.DEAD_LETTER_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDeadLetterMessage</span><span class="hljs-params">(Order order, Channel channel, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="hljs-type">long</span> tag)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 处理订单超时逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;Processing dead letter message for order: &quot;</span> + order.getId());<br>            orderService.closeOrder(order.getId()); <span class="hljs-comment">// 关闭订单</span><br>            orderService.rollbackInventory(order); <span class="hljs-comment">// 回滚库存</span><br><br>            <span class="hljs-comment">// 手动ACK</span><br>            channel.basicAck(tag, <span class="hljs-literal">false</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Failed to process dead letter message: &quot;</span> + e.getMessage());<br>            <span class="hljs-comment">// 手动NACK</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                channel.basicNack(tag, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>                ioException.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-关闭订单和回滚库存"><a href="#6-关闭订单和回滚库存" class="headerlink" title="6. 关闭订单和回滚库存"></a>6. <strong>关闭订单和回滚库存</strong></h4><p><strong>具体实现：</strong><br>在订单服务中实现关闭订单和回滚库存的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderRepository orderRepository;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InventoryService inventoryService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(Long orderId)</span> &#123;<br>        <span class="hljs-comment">// 关闭订单逻辑</span><br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderRepository.findById(orderId).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Order not found&quot;</span>));<br>        order.setStatus(<span class="hljs-string">&quot;CLOSED&quot;</span>);<br>        orderRepository.save(order);<br>        System.out.println(<span class="hljs-string">&quot;Order closed: &quot;</span> + orderId);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollbackInventory</span><span class="hljs-params">(Order order)</span> &#123;<br>        <span class="hljs-comment">// 回滚库存逻辑</span><br>        inventoryService.rollbackInventory(order.getProductId(), order.getQuantity());<br>        System.out.println(<span class="hljs-string">&quot;Inventory rolled back for order: &quot;</span> + order.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>延迟队列</strong>：使用RabbitMQ的延迟队列功能，将订单消息延迟30分钟发送。</li>
<li><strong>死信队列</strong>：当延迟消息到期后，消息被发送到死信队列，触发订单关闭和库存回滚逻辑。</li>
<li><strong>消息可靠性</strong>：通过生产者确认机制（<code>publisher-confirms</code>）和消费者手动ACK（<code>acknowledge-mode: manual</code>），确保消息的可靠传递。</li>
</ol>
<h2 id="4-商品搜索优化（Elasticsearch）"><a href="#4-商品搜索优化（Elasticsearch）" class="headerlink" title="4. 商品搜索优化（Elasticsearch）"></a><strong>4. 商品搜索优化（Elasticsearch）</strong></h2><h3 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h3><p>在电商平台中，用户需要快速且准确地搜索商品，尤其是当商品数量庞大且信息丰富时。传统的数据库全文检索功能有限，难以满足复杂的搜索需求，如模糊搜索、多字段搜索、排序和聚合分析等。Elasticsearch作为一个高性能的搜索引擎，能够提供强大的全文检索功能和实时数据分析能力。结合IK分词器和拼音插件，可以实现智能搜索，支持中文分词和拼音匹配，提升用户体验。</p>
<hr>
<h3 id="实现方法-3"><a href="#实现方法-3" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-引入Elasticsearch依赖"><a href="#1-引入Elasticsearch依赖" class="headerlink" title="1. 引入Elasticsearch依赖"></a>1. <strong>引入Elasticsearch依赖</strong></h4><p><strong>技术选型：</strong> 使用Elasticsearch作为搜索引擎。</p>
<p><strong>具体实现：</strong><br>在<code>pom.xml</code>文件中引入Elasticsearch的Spring Boot Starter依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-配置Elasticsearch"><a href="#2-配置Elasticsearch" class="headerlink" title="2. 配置Elasticsearch"></a>2. <strong>配置Elasticsearch</strong></h4><p><strong>具体实现：</strong><br>在<code>application.yml</code>文件中配置Elasticsearch的连接信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">elasticsearch:</span><br>    <span class="hljs-attr">rest:</span><br>      <span class="hljs-attr">uris:</span> <span class="hljs-string">http://localhost:9200</span><br></code></pre></td></tr></table></figure>

<h4 id="3-创建Elasticsearch索引和映射"><a href="#3-创建Elasticsearch索引和映射" class="headerlink" title="3. 创建Elasticsearch索引和映射"></a>3. <strong>创建Elasticsearch索引和映射</strong></h4><p><strong>具体实现：</strong><br>定义一个实体类<code>Product</code>，并使用<code>@Document</code>注解指定Elasticsearch的索引名称和分片设置。同时，定义字段的映射类型，例如使用<code>text</code>类型支持全文检索：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Document(indexName = &quot;product&quot;, shards = 1, replicas = 0)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String category;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Double)</span><br>    <span class="hljs-keyword">private</span> Double price;<br><br>    <span class="hljs-comment">// Getters and Setters</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-配置IK分词器和拼音插件"><a href="#4-配置IK分词器和拼音插件" class="headerlink" title="4. 配置IK分词器和拼音插件"></a>4. <strong>配置IK分词器和拼音插件</strong></h4><p><strong>具体实现：</strong><br>在Elasticsearch中安装IK分词器和拼音插件。可以通过以下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装IK分词器</span><br>./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.10.2/elasticsearch-analysis-ik-7.10.2.zip<br><br><span class="hljs-comment"># 安装拼音插件</span><br>./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.10.2/elasticsearch-analysis-pinyin-7.10.2.zip<br></code></pre></td></tr></table></figure>

<p>在Elasticsearch的<code>elasticsearch.yml</code>文件中配置分词器和拼音插件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">index.analysis.analyzer.ik_max_word.type:</span> <span class="hljs-string">custom</span><br><span class="hljs-attr">index.analysis.analyzer.ik_max_word.tokenizer:</span> <span class="hljs-string">ik_max_word</span><br><span class="hljs-attr">index.analysis.analyzer.ik_max_word.filter:</span> [<span class="hljs-string">pinyin</span>]<br></code></pre></td></tr></table></figure>

<h4 id="5-创建Elasticsearch-Repository"><a href="#5-创建Elasticsearch-Repository" class="headerlink" title="5. 创建Elasticsearch Repository"></a>5. <strong>创建Elasticsearch Repository</strong></h4><p><strong>具体实现：</strong><br>创建一个继承自<code>ElasticsearchRepository</code>的接口，用于操作Elasticsearch索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;Product, Long&gt; &#123;<br>    List&lt;Product&gt; <span class="hljs-title function_">findByNameContaining</span><span class="hljs-params">(String keyword)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-实现商品搜索功能"><a href="#6-实现商品搜索功能" class="headerlink" title="6. 实现商品搜索功能"></a>6. <strong>实现商品搜索功能</strong></h4><p><strong>具体实现：</strong><br>在Service层中实现商品搜索功能，使用Elasticsearch的查询功能进行全文检索和聚合分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductRepository productRepository;<br><br>    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">searchProducts</span><span class="hljs-params">(String keyword)</span> &#123;<br>        <span class="hljs-comment">// 使用Elasticsearch的全文检索功能</span><br>        <span class="hljs-keyword">return</span> productRepository.findByNameContaining(keyword);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">indexProduct</span><span class="hljs-params">(Product product)</span> &#123;<br>        <span class="hljs-comment">// 将商品信息索引到Elasticsearch</span><br>        productRepository.save(product);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-优化搜索性能"><a href="#7-优化搜索性能" class="headerlink" title="7. 优化搜索性能"></a>7. <strong>优化搜索性能</strong></h4><p><strong>具体实现：</strong><br>为了确保搜索响应时间小于200ms，可以采取以下优化措施：</p>
<ul>
<li><strong>索引优化</strong>：合理设置Elasticsearch的索引参数，如分片数和副本数。</li>
<li><strong>查询优化</strong>：使用Elasticsearch的DSL查询语言，优化查询语句，避免全表扫描。</li>
<li><strong>缓存机制</strong>：对于热点数据，可以结合Redis进行缓存，减少对Elasticsearch的直接访问。</li>
</ul>
<p>以下是一个优化后的查询示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductRepository productRepository;<br><br>    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">searchProducts</span><span class="hljs-params">(String keyword)</span> &#123;<br>        <span class="hljs-comment">// 构建Elasticsearch查询</span><br>        <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">queryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>        queryBuilder.withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>));<br><br>        <span class="hljs-comment">// 添加聚合分析</span><br>        queryBuilder.addAggregation(AggregationBuilders.terms(<span class="hljs-string">&quot;category_agg&quot;</span>).field(<span class="hljs-string">&quot;category&quot;</span>));<br><br>        <span class="hljs-comment">// 执行查询</span><br>        <span class="hljs-type">NativeSearchQuery</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> queryBuilder.build();<br>        SearchHits&lt;Product&gt; searchHits = productRepository.search(query);<br><br>        <span class="hljs-comment">// 解析结果</span><br>        List&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SearchHit&lt;Product&gt; hit : searchHits) &#123;<br>            products.add(hit.getContent());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> products;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>全文检索</strong>：使用Elasticsearch实现商品的全文检索功能，支持模糊搜索和多字段搜索。</li>
<li><strong>智能搜索</strong>：结合IK分词器和拼音插件，支持中文分词和拼音匹配，提升搜索的准确性和用户体验。</li>
<li><strong>聚合分析</strong>：通过Elasticsearch的聚合功能，实现商品分类统计、价格区间统计等分析功能。</li>
<li><strong>高性能</strong>：通过优化索引设置、查询语句和缓存机制，确保搜索响应时间小于200ms。</li>
</ol>
<h2 id="5-多级缓存架构（Caffeine-Redis）"><a href="#5-多级缓存架构（Caffeine-Redis）" class="headerlink" title="5. 多级缓存架构（Caffeine + Redis）"></a><strong>5. 多级缓存架构（Caffeine + Redis）</strong></h2><h3 id="使用场景-4"><a href="#使用场景-4" class="headerlink" title="使用场景"></a>使用场景</h3><p>在电商平台中，商品详情页是用户访问频率最高的页面之一。为了提升用户体验并减轻数据库的压力，需要对商品详情数据进行缓存。同时，为了应对高并发场景，需要采用多级缓存架构，确保数据的快速读取和高可用性。此外，还需要解决缓存穿透问题，避免因查询不存在的商品而导致数据库压力过大。</p>
<hr>
<h3 id="实现方法-4"><a href="#实现方法-4" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-引入相关依赖"><a href="#1-引入相关依赖" class="headerlink" title="1. 引入相关依赖"></a>1. <strong>引入相关依赖</strong></h4><p><strong>技术选型：</strong> 使用Caffeine作为本地缓存，Redis作为分布式缓存，Guava的布隆过滤器解决缓存穿透问题。</p>
<p><strong>具体实现：</strong><br>在<code>pom.xml</code>文件中引入Caffeine、Redis和布隆过滤器的相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-配置Redis集群"><a href="#2-配置Redis集群" class="headerlink" title="2. 配置Redis集群"></a>2. <strong>配置Redis集群</strong></h4><p><strong>具体实现：</strong><br>在<code>application.yml</code>文件中配置Redis集群信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span> <span class="hljs-string">node1:6379,node2:6379,node3:6379</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">-1ms</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h4 id="3-配置Caffeine缓存"><a href="#3-配置Caffeine缓存" class="headerlink" title="3. 配置Caffeine缓存"></a>3. <strong>配置Caffeine缓存</strong></h4><p><strong>具体实现：</strong><br>创建一个配置类，配置Caffeine缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CaffeineCacheManager <span class="hljs-title function_">caffeineCacheManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CaffeineCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>(<span class="hljs-string">&quot;hotProducts&quot;</span>);<br>        cacheManager.setCaffeine(caffeineCacheBuilder());<br>        <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br><br>    Caffeine&lt;Object, Object&gt; <span class="hljs-title function_">caffeineCacheBuilder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES) <span class="hljs-comment">// 设置TTL为5分钟</span><br>                .maximumSize(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 设置最大缓存条目数</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-实现多级缓存架构"><a href="#4-实现多级缓存架构" class="headerlink" title="4. 实现多级缓存架构"></a>4. <strong>实现多级缓存架构</strong></h4><p><strong>具体实现：</strong><br>在Service层中实现多级缓存逻辑，优先从本地Caffeine缓存读取数据，如果未命中则从Redis集群读取，最后从数据库读取并更新缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductRepository productRepository;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Product&gt; redisTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheManager cacheManager;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOT_PRODUCTS_CACHE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hotProducts&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REDIS_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product:&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 从本地Caffeine缓存读取</span><br>        Cache.<span class="hljs-type">ValueWrapper</span> <span class="hljs-variable">valueWrapper</span> <span class="hljs-operator">=</span> cacheManager.getCache(HOT_PRODUCTS_CACHE).get(id.toString());<br>        <span class="hljs-keyword">if</span> (valueWrapper != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> (Product) valueWrapper.get();<br>        &#125;<br><br>        <span class="hljs-comment">// 从Redis集群读取</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> REDIS_KEY_PREFIX + id;<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(redisKey);<br>        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新本地缓存</span><br>            cacheManager.getCache(HOT_PRODUCTS_CACHE).put(id.toString(), product);<br>            <span class="hljs-keyword">return</span> product;<br>        &#125;<br><br>        <span class="hljs-comment">// 从数据库读取</span><br>        product = productRepository.findById(id).orElse(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新Redis集群缓存</span><br>            redisTemplate.opsForValue().set(redisKey, product, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>            <span class="hljs-comment">// 更新本地缓存</span><br>            cacheManager.getCache(HOT_PRODUCTS_CACHE).put(id.toString(), product);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> product;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-解决缓存穿透问题"><a href="#5-解决缓存穿透问题" class="headerlink" title="5. 解决缓存穿透问题"></a>5. <strong>解决缓存穿透问题</strong></h4><p><strong>具体实现：</strong><br>使用布隆过滤器存储已知存在的商品ID，同时对不存在的商品ID进行空值缓存，避免重复查询数据库。</p>
<ul>
<li><p><strong>配置布隆过滤器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloomFilterConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> BloomFilter&lt;Long&gt; <span class="hljs-title function_">bloomFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">expectedInsertions</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000</span>; <span class="hljs-comment">// 预计插入的商品ID数量</span><br>        <span class="hljs-type">double</span> <span class="hljs-variable">fpp</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.01</span>; <span class="hljs-comment">// 误判率</span><br>        <span class="hljs-keyword">return</span> BloomFilter.create(Funnels.longFunnel(), expectedInsertions, fpp);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>更新缓存逻辑</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductRepository productRepository;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Product&gt; redisTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheManager cacheManager;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> BloomFilter&lt;Long&gt; bloomFilter;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOT_PRODUCTS_CACHE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hotProducts&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REDIS_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product:&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMPTY_PRODUCT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;empty_product&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 检查布隆过滤器</span><br>        <span class="hljs-keyword">if</span> (!bloomFilter.mightContain(id)) &#123;<br>            <span class="hljs-comment">// 缓存穿透，直接返回空</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 从本地Caffeine缓存读取</span><br>        Cache.<span class="hljs-type">ValueWrapper</span> <span class="hljs-variable">valueWrapper</span> <span class="hljs-operator">=</span> cacheManager.getCache(HOT_PRODUCTS_CACHE).get(id.toString());<br>        <span class="hljs-keyword">if</span> (valueWrapper != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> (Product) valueWrapper.get();<br>        &#125;<br><br>        <span class="hljs-comment">// 从Redis集群读取</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> REDIS_KEY_PREFIX + id;<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(redisKey);<br>        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新本地缓存</span><br>            cacheManager.getCache(HOT_PRODUCTS_CACHE).put(id.toString(), product);<br>            <span class="hljs-keyword">return</span> product;<br>        &#125;<br><br>        <span class="hljs-comment">// 从数据库读取</span><br>        product = productRepository.findById(id).orElse(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新Redis集群缓存</span><br>            redisTemplate.opsForValue().set(redisKey, product, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>            <span class="hljs-comment">// 更新本地缓存</span><br>            cacheManager.getCache(HOT_PRODUCTS_CACHE).put(id.toString(), product);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 空值缓存</span><br>            redisTemplate.opsForValue().set(redisKey, EMPTY_PRODUCT, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> product;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-使用Lua脚本保障Redis操作的原子性"><a href="#6-使用Lua脚本保障Redis操作的原子性" class="headerlink" title="6. 使用Lua脚本保障Redis操作的原子性"></a>6. <strong>使用Lua脚本保障Redis操作的原子性</strong></h4><p><strong>具体实现：</strong><br>在更新Redis缓存时，使用Lua脚本确保操作的原子性。例如，更新商品详情时可以使用以下Lua脚本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductInRedis</span><span class="hljs-params">(Long id, Product product)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product:&quot;</span> + id;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;exists&#x27;, KEYS[1]) == 1 then &quot;</span> +<br>                <span class="hljs-string">&quot;redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1], &#x27;EX&#x27;, ARGV[2]) &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1], &#x27;EX&#x27;, ARGV[2]) &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        DefaultRedisScript&lt;Long&gt; script = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        script.setScriptText(luaScript);<br>        script.setResultType(Long.class);<br>        List&lt;String&gt; keys = Collections.singletonList(redisKey);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute(script, keys, product, <span class="hljs-number">300</span>); <span class="hljs-comment">// 300秒过期时间</span><br>        System.out.println(<span class="hljs-string">&quot;Redis update result: &quot;</span> + result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>多级缓存架构</strong>：本地Caffeine缓存热点数据，Redis集群缓存商品详情，确保数据快速读取和高可用性。</li>
<li><strong>缓存穿透解决方案</strong>：使用布隆过滤器存储已知存在的商品ID，对不存在的商品ID进行空值缓存，避免重复查询数据库。</li>
<li><strong>原子性操作</strong>：使用Lua脚本保障Redis操作的原子性，确保缓存数据的一致性。</li>
</ol>
<h2 id="6-解决雪崩问题"><a href="#6-解决雪崩问题" class="headerlink" title="6. 解决雪崩问题"></a><strong>6. 解决雪崩问题</strong></h2><h3 id="使用场景-5"><a href="#使用场景-5" class="headerlink" title="使用场景"></a>使用场景</h3><p>在高并发的电商平台中，服务雪崩是一个常见的问题。当某个服务出现故障或响应缓慢时，可能会导致调用它的服务也出现故障，进而引发一系列连锁反应，最终导致整个系统不可用。为了防止这种情况的发生，需要采取多种措施来解决雪崩问题，确保核心链路的稳定性。具体措施包括：</p>
<ol>
<li><strong>请求超时控制</strong>：限制服务调用的超时时间，避免长时间等待。</li>
<li><strong>舱壁模式隔离线程池</strong>：通过线程池隔离，防止某个服务的故障影响到其他服务。</li>
<li><strong>异步MQ消息重试机制</strong>：使用消息队列进行异步处理，并在失败时进行重试，避免直接调用导致的阻塞。</li>
</ol>
<hr>
<h3 id="实现方法-5"><a href="#实现方法-5" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-请求超时控制"><a href="#1-请求超时控制" class="headerlink" title="1. 请求超时控制"></a>1. <strong>请求超时控制</strong></h4><p><strong>技术选型：</strong> 使用Hystrix（或Sentinel）进行请求超时控制。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>引入Hystrix依赖</strong><br>在<code>pom.xml</code>文件中引入Hystrix依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Hystrix超时时间</strong><br>在<code>application.yml</code>文件中配置Hystrix的超时时间，例如设置为200ms：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>使用Hystrix注解</strong><br>在服务调用接口中使用<code>@HystrixCommand</code>注解，指定超时时间和降级方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductClient productClient;<br><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;getProductFallback&quot;, commandProperties = &#123;</span><br><span class="hljs-meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;200&quot;)</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> productClient.getProductById(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductFallback</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 返回降级后的结果，例如返回一个默认的产品信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;Product is not available.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-舱壁模式隔离线程池"><a href="#2-舱壁模式隔离线程池" class="headerlink" title="2. 舱壁模式隔离线程池"></a>2. <strong>舱壁模式隔离线程池</strong></h4><p><strong>技术选型：</strong> 使用Hystrix（或Sentinel）的线程池隔离机制。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>配置Hystrix线程池</strong><br>在<code>application.yml</code>文件中配置Hystrix的线程池，例如为每个服务分配独立的线程池：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">threadpool:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">coreSize:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">maxQueueSize:</span> <span class="hljs-number">100</span><br>      <span class="hljs-attr">queueSizeRejectionThreshold:</span> <span class="hljs-number">50</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>使用Hystrix线程池</strong><br>在服务调用接口中使用<code>@HystrixCommand</code>注解，指定线程池名称：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductClient productClient;<br><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;getProductFallback&quot;, commandProperties = &#123;</span><br><span class="hljs-meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;200&quot;)</span><br><span class="hljs-meta">    &#125;, threadPoolKey = &quot;productThreadPool&quot;)</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> productClient.getProductById(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductFallback</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 返回降级后的结果</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;Product is not available.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-异步MQ消息重试机制"><a href="#3-异步MQ消息重试机制" class="headerlink" title="3. 异步MQ消息重试机制"></a>3. <strong>异步MQ消息重试机制</strong></h4><p><strong>技术选型：</strong> 使用RabbitMQ实现异步消息处理，并结合Spring Retry进行消息重试。</p>
<p><strong>具体实现：</strong></p>
<ul>
<li><p><strong>引入RabbitMQ和Spring Retry依赖</strong><br>在<code>pom.xml</code>文件中引入RabbitMQ和Spring Retry依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.retry<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-retry<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>配置RabbitMQ</strong><br>在<code>application.yml</code>文件中配置RabbitMQ的连接信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>定义消息发送方法</strong><br>在服务中定义消息发送方法，使用<code>RabbitTemplate</code>发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderMessage</span><span class="hljs-params">(Order order)</span> &#123;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;orderQueue&quot;</span>, order);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>定义消息消费者</strong><br>在消费者中定义消息处理方法，并使用<code>@Retryable</code>注解实现重试机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumer</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = &quot;orderQueue&quot;)</span><br>    <span class="hljs-meta">@Retryable(value = Exception.class, maxAttempts = 3, backoff = @Backoff(delay = 5000))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> &#123;<br>        <span class="hljs-comment">// 处理订单逻辑</span><br>        System.out.println(<span class="hljs-string">&quot;Processing order: &quot;</span> + order.getId());<br>        <span class="hljs-comment">// 模拟处理失败</span><br>        <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.5</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Order processing failed.&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Recover</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recover</span><span class="hljs-params">(Exception ex, Order order)</span> &#123;<br>        <span class="hljs-comment">// 处理失败后的逻辑，例如记录日志或发送告警</span><br>        System.out.println(<span class="hljs-string">&quot;Order processing failed after retries: &quot;</span> + order.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>请求超时控制</strong>：通过Hystrix设置服务调用的超时时间，避免长时间等待导致的服务阻塞。</li>
<li><strong>舱壁模式隔离线程池</strong>：通过Hystrix的线程池隔离机制，为每个服务分配独立的线程池，防止某个服务的故障影响到其他服务。</li>
<li><strong>异步MQ消息重试机制</strong>：使用RabbitMQ实现异步消息处理，并结合Spring Retry进行消息重试，避免直接调用导致的阻塞和失败。</li>
</ol>
<h2 id="7-数据持久化优化（Mybatis-Plus）"><a href="#7-数据持久化优化（Mybatis-Plus）" class="headerlink" title="7. 数据持久化优化（Mybatis-Plus）"></a><strong>7. 数据持久化优化（Mybatis-Plus）</strong></h2><h3 id="使用场景-6"><a href="#使用场景-6" class="headerlink" title="使用场景"></a>使用场景</h3><p>在电商平台的开发中，涉及到大量的数据库操作，例如用户信息管理、订单处理、商品信息查询等。传统的方式需要手动编写大量的SQL语句和对应的Mapper接口方法，这不仅增加了开发工作量，还容易出错。MyBatis-Plus作为MyBatis的增强工具，提供了自动化的CRUD操作功能，能够显著简化开发流程，减少重复代码，提升开发效率。</p>
<hr>
<h3 id="实现方法-6"><a href="#实现方法-6" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-引入MyBatis-Plus依赖"><a href="#1-引入MyBatis-Plus依赖" class="headerlink" title="1. 引入MyBatis-Plus依赖"></a>1. <strong>引入MyBatis-Plus依赖</strong></h4><p><strong>技术选型：</strong> 使用MyBatis-Plus作为ORM框架。</p>
<p><strong>具体实现：</strong><br>在<code>pom.xml</code>文件中引入MyBatis-Plus依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请根据实际情况选择合适的版本 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-配置MyBatis-Plus"><a href="#2-配置MyBatis-Plus" class="headerlink" title="2. 配置MyBatis-Plus"></a>2. <strong>配置MyBatis-Plus</strong></h4><p><strong>具体实现：</strong><br>在<code>application.yml</code>文件中配置MyBatis-Plus的基本信息，例如数据库连接、SQL日志等：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/your_db_name?useSSL=false&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mappers/*.xml</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.yourproject.entity</span><br></code></pre></td></tr></table></figure>

<h4 id="3-创建实体类"><a href="#3-创建实体类" class="headerlink" title="3. 创建实体类"></a>3. <strong>创建实体类</strong></h4><p><strong>具体实现：</strong><br>定义一个实体类，例如<code>User</code>，并使用<code>@TableName</code>注解指定表名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yourproject.entity;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><br><span class="hljs-meta">@TableName(&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> String email;<br><br>    <span class="hljs-comment">// Getters and Setters</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEmail</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> email;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEmail</span><span class="hljs-params">(String email)</span> &#123;<br>        <span class="hljs-built_in">this</span>.email = email;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-创建Mapper接口"><a href="#4-创建Mapper接口" class="headerlink" title="4. 创建Mapper接口"></a>4. <strong>创建Mapper接口</strong></h4><p><strong>具体实现：</strong><br>创建一个Mapper接口，例如<code>UserMapper</code>，并继承<code>BaseMapper</code>。<code>BaseMapper</code>提供了基本的CRUD操作方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yourproject.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.yourproject.entity.User;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br>    <span class="hljs-comment">// 在这里可以添加一些自定义的SQL操作方法</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-使用MyBatis-Plus进行CRUD操作"><a href="#5-使用MyBatis-Plus进行CRUD操作" class="headerlink" title="5. 使用MyBatis-Plus进行CRUD操作"></a>5. <strong>使用MyBatis-Plus进行CRUD操作</strong></h4><p><strong>具体实现：</strong><br>在Service层或Controller层中注入Mapper接口，并使用其提供的CRUD方法进行数据库操作。</p>
<ul>
<li><p><strong>插入数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span> &#123;<br>        userMapper.insert(user); <span class="hljs-comment">// 自动插入数据</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>查询数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/users&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.getUserById(id);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userMapper.selectById(id); <span class="hljs-comment">// 自动根据ID查询</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>更新数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        userMapper.updateById(user); <span class="hljs-comment">// 自动根据ID更新</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>删除数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> &#123;<br>        userMapper.deleteById(id); <span class="hljs-comment">// 自动根据ID删除</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>简化开发工作</strong>：通过继承<code>BaseMapper</code>，自动提供了基本的CRUD操作方法，无需手动编写SQL语句和Mapper接口方法。</li>
<li><strong>减少代码重复度</strong>：避免了大量重复的SQL操作代码，使得代码更加简洁和易于维护。</li>
<li><strong>提升开发效率</strong>：开发者可以专注于业务逻辑的实现，而无需花费大量时间在数据库操作的实现上。</li>
</ol>
<h2 id="8-分布式链路追踪（SkyWalking-x2F-Zipkin）"><a href="#8-分布式链路追踪（SkyWalking-x2F-Zipkin）" class="headerlink" title="8. 分布式链路追踪（SkyWalking&#x2F;Zipkin）"></a><strong>8. 分布式链路追踪（SkyWalking&#x2F;Zipkin）</strong></h2><p><strong>场景</strong>：<br>用户下单请求需经过网关→订单服务→库存服务→支付服务，链路复杂，需快速定位性能瓶颈或故障点。<br><strong>技术实现</strong>：  </p>
<ul>
<li>集成 <strong>SkyWalking</strong>，通过探针自动采集服务间调用链路的耗时、状态、异常信息，生成可视化拓扑图。  </li>
<li>结合 <strong>Trace ID</strong> 实现全链路日志关联，例如通过日志中的唯一ID追踪某个订单在所有微服务中的处理过程。  </li>
<li>核心价值：降低跨服务调试难度，快速识别慢查询（如某个数据库操作耗时突增）。</li>
</ul>
<hr>
<h2 id="9-分库分表与读写分离（ShardingSphere）"><a href="#9-分库分表与读写分离（ShardingSphere）" class="headerlink" title="9. 分库分表与读写分离（ShardingSphere）"></a><strong>9. 分库分表与读写分离（ShardingSphere）</strong></h2><p><strong>场景</strong>：<br>订单表数据量超千万级，单库性能无法支撑高并发读写。<br><strong>技术实现</strong>：  </p>
<ul>
<li>使用 <strong>ShardingSphere</strong> 对订单表按用户ID哈希分片，分散到多个数据库实例，提升写入吞吐量。  </li>
<li>读写分离：写操作走主库，读操作路由到从库，通过 <strong>MySQL主从同步</strong> 保障数据一致性。  </li>
<li>动态扩缩容：通过分片策略灵活扩展数据库节点，适应业务增长。</li>
</ul>
<hr>
<h2 id="10-基于Seata-AT模式解决跨服务库存扣减与订单创建的分布式事务问题"><a href="#10-基于Seata-AT模式解决跨服务库存扣减与订单创建的分布式事务问题" class="headerlink" title="10. 基于Seata AT模式解决跨服务库存扣减与订单创建的分布式事务问题"></a><strong>10. 基于Seata AT模式解决跨服务库存扣减与订单创建的分布式事务问题</strong></h2><h3 id="使用场景-7"><a href="#使用场景-7" class="headerlink" title="使用场景"></a>使用场景</h3><p>在电商平台中，订单创建和库存扣减是两个核心操作，通常涉及多个微服务。例如，订单服务负责创建订单，而库存服务负责扣减库存。这两个操作需要在一个事务中完成，以确保数据的一致性。如果订单创建成功但库存扣减失败，或者反之，会导致数据不一致的问题。Seata的AT（Automatic Transaction）模式能够很好地解决这种跨服务的分布式事务问题，通过两阶段提交的方式确保事务的原子性。</p>
<hr>
<h3 id="实现方法-7"><a href="#实现方法-7" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="1-引入Seata依赖"><a href="#1-引入Seata依赖" class="headerlink" title="1. 引入Seata依赖"></a>1. <strong>引入Seata依赖</strong></h4><p><strong>技术选型：</strong> 使用Seata作为分布式事务解决方案。</p>
<p><strong>具体实现：</strong><br>在<code>pom.xml</code>文件中引入Seata的Spring Cloud集成依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请根据实际情况选择合适的版本 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>同时，需要引入Seata的客户端依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-配置Seata"><a href="#2-配置Seata" class="headerlink" title="2. 配置Seata"></a>2. <strong>配置Seata</strong></h4><p><strong>具体实现：</strong><br>在<code>application.yml</code>文件中配置Seata的客户端信息，包括事务服务组、事务服务地址等：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">application-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_service_group</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">vgroup-mapping:</span><br>      <span class="hljs-attr">my_tx_service_group:</span> <span class="hljs-string">default</span><br>    <span class="hljs-attr">grouplist:</span><br>      <span class="hljs-attr">default:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8091</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">undo-log:</span><br>      <span class="hljs-attr">table-name:</span> <span class="hljs-string">undo_log</span><br>      <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">AT</span><br></code></pre></td></tr></table></figure>

<p>同时，需要在数据库中创建<code>undo_log</code>表，用于存储事务日志：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `undo_log` (<br>  `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `branch_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `context` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `rollback_info` LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_status` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_created` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_modified` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<h4 id="3-创建订单服务"><a href="#3-创建订单服务" class="headerlink" title="3. 创建订单服务"></a>3. <strong>创建订单服务</strong></h4><p><strong>具体实现：</strong><br>在订单服务中，使用<code>@GlobalTransactional</code>注解标记订单创建方法，确保该方法中的所有操作都在一个全局事务中执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderRepository orderRepository;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InventoryClient inventoryClient;<br><br>    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> &#123;<br>        <span class="hljs-comment">// 创建订单</span><br>        order.setStatus(<span class="hljs-string">&quot;CREATED&quot;</span>);<br>        orderRepository.save(order);<br>        System.out.println(<span class="hljs-string">&quot;Order created: &quot;</span> + order.getId());<br><br>        <span class="hljs-comment">// 扣减库存</span><br>        <span class="hljs-type">InventoryRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryRequest</span>(order.getProductId(), order.getQuantity());<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inventoryClient.deductInventory(request);<br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Inventory deduction failed.&quot;</span>);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;Inventory deducted for order: &quot;</span> + order.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-创建库存服务"><a href="#4-创建库存服务" class="headerlink" title="4. 创建库存服务"></a>4. <strong>创建库存服务</strong></h4><p><strong>具体实现：</strong><br>在库存服务中，使用<code>@GlobalTransactional</code>注解标记库存扣减方法，确保该方法中的所有操作都在一个全局事务中执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InventoryRepository inventoryRepository;<br><br>    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(Long productId, Integer quantity)</span> &#123;<br>        <span class="hljs-comment">// 查询库存</span><br>        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> inventoryRepository.findById(productId).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Product not found&quot;</span>));<br>        <span class="hljs-keyword">if</span> (inventory.getQuantity() &lt; quantity) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Insufficient inventory.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 扣减库存</span><br>        inventory.setQuantity(inventory.getQuantity() - quantity);<br>        inventoryRepository.save(inventory);<br>        System.out.println(<span class="hljs-string">&quot;Inventory deducted for product: &quot;</span> + productId);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-配置Feign客户端"><a href="#5-配置Feign客户端" class="headerlink" title="5. 配置Feign客户端"></a>5. <strong>配置Feign客户端</strong></h4><p><strong>具体实现：</strong><br>在订单服务中，定义一个Feign客户端，用于调用库存服务的扣减库存接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;inventory-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryClient</span> &#123;<br>    <span class="hljs-meta">@PostMapping(&quot;/inventory/deduct&quot;)</span><br>    Boolean <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> InventoryRequest request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-启动Seata-Server"><a href="#6-启动Seata-Server" class="headerlink" title="6. 启动Seata Server"></a>6. <strong>启动Seata Server</strong></h4><p><strong>具体实现：</strong><br>下载并启动Seata Server。可以从Seata的GitHub仓库下载最新版本的Seata Server，并按照文档启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 下载Seata Server</span><br>wget https://github.com/seata/seata/releases/download/v1.5.2/seata-server-1.5.2.zip<br><br><span class="hljs-comment"># 解压并启动Seata Server</span><br>unzip seata-server-1.5.2.zip<br><span class="hljs-built_in">cd</span> seata-server-1.5.2/bin<br>./seata-server.sh -p 8091 -h 127.0.0.1<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h3><p>通过上述实现方法，项目能够实现以下功能：</p>
<ol>
<li><strong>分布式事务管理</strong>：使用Seata的AT模式，确保订单创建和库存扣减操作在一个全局事务中完成，保证数据的一致性。</li>
<li><strong>事务回滚</strong>：如果订单创建成功但库存扣减失败，或者反之，Seata会自动回滚事务，确保系统状态的一致性。</li>
<li><strong>两阶段提交</strong>：Seata通过两阶段提交的方式，确保事务的原子性，避免部分操作成功而部分操作失败导致的数据不一致问题。</li>
</ol>
<h4 id="11-日志集中化分析（ELK-Stack）"><a href="#11-日志集中化分析（ELK-Stack）" class="headerlink" title="11. 日志集中化分析（ELK Stack）"></a><strong>11. 日志集中化分析（ELK Stack）</strong></h4><p><strong>场景</strong>：<br>微服务日志分散在多个容器中，排查问题需登录多个服务器，效率低下。<br><strong>技术实现</strong>：  </p>
<ul>
<li><strong>Filebeat</strong> 采集各容器日志，发送至 <strong>Logstash</strong> 进行过滤和格式化。  </li>
<li><strong>Elasticsearch</strong> 存储结构化日志，<strong>Kibana</strong> 提供可视化看板，支持关键词搜索（如“订单超时”）。  </li>
<li>核心价值：实时监控错误日志（如500状态码），快速定位异常服务。</li>
</ul>
<hr>
<h4 id="12-持续集成与交付（CI-x2F-CD）"><a href="#12-持续集成与交付（CI-x2F-CD）" class="headerlink" title="12. 持续集成与交付（CI&#x2F;CD）"></a><strong>12. 持续集成与交付（CI&#x2F;CD）</strong></h4><p><strong>场景</strong>：<br>频繁的功能迭代需保证代码质量并快速部署到测试&#x2F;生产环境。<br><strong>技术实现</strong>：  </p>
<ul>
<li><strong>Jenkins&#x2F;GitLab CI</strong> 自动化流水线：代码提交后触发单元测试、代码扫描（SonarQube）、镜像构建与推送。  </li>
<li><strong>Kubernetes滚动更新</strong>：新版本服务镜像逐步替换旧实例，实现零停机发布。  </li>
<li>核心价值：减少人为失误，提升发布效率（从小时级缩短至分钟级）。</li>
</ul>
<hr>
<h4 id="13-安全加固（OAuth2-Spring-Security）"><a href="#13-安全加固（OAuth2-Spring-Security）" class="headerlink" title="13. 安全加固（OAuth2 + Spring Security）"></a><strong>13. 安全加固（OAuth2 + Spring Security）</strong></h4><p><strong>场景</strong>：<br>用户敏感操作（如支付、修改密码）需防范CSRF、XSS攻击，并实现精细化的权限控制。<br><strong>技术实现</strong>：  </p>
<ul>
<li><strong>OAuth2授权码模式</strong>：第三方应用（如合作商户）接入时，通过授权服务器获取访问令牌，避免密码泄露。  </li>
<li><strong>RBAC权限模型</strong>：基于角色的访问控制，例如“管理员”可删除商品，“普通用户”仅可浏览。  </li>
<li><strong>请求过滤</strong>：通过Spring Security的 <code>XSSFilter</code> 对用户输入进行转义，防止脚本注入。</li>
</ul>
<hr>
<h4 id="14-容器编排与自动化扩缩容（Kubernetes）"><a href="#14-容器编排与自动化扩缩容（Kubernetes）" class="headerlink" title="14. 容器编排与自动化扩缩容（Kubernetes）"></a><strong>14. 容器编排与自动化扩缩容（Kubernetes）</strong></h4><p><strong>场景</strong>：<br>大促期间订单服务需快速扩容以应对流量高峰，活动结束后自动缩容以节省资源。<br><strong>技术实现</strong>：  </p>
<ul>
<li><strong>HPA（水平Pod自动扩缩容）</strong>：根据CPU&#x2F;内存使用率或自定义指标（如QPS）动态调整Pod数量。  </li>
<li><strong>服务网格（Istio）</strong>：精细化流量管理（如A&#x2F;B测试），故障注入模拟服务异常，测试系统容错能力。</li>
</ul>
<hr>
<h4 id="15-压力测试与性能调优（JMeter-Arthas）"><a href="#15-压力测试与性能调优（JMeter-Arthas）" class="headerlink" title="15. 压力测试与性能调优（JMeter + Arthas）"></a><strong>15. 压力测试与性能调优（JMeter + Arthas）</strong></h4><p><strong>场景</strong>：<br>需验证系统在万级并发下的稳定性，并优化接口响应时间。<br><strong>技术实现</strong>：  </p>
<ul>
<li><strong>JMeter模拟压测</strong>：构造高并发下单场景（如1万用户同时抢购），观察数据库连接池、线程池等资源瓶颈。  </li>
<li><strong>Arthas在线诊断</strong>：通过 <code>trace</code> 命令追踪方法调用链耗时，定位慢SQL或锁竞争问题。  </li>
<li>优化手段：调整JVM参数（如堆内存分配）、优化SQL索引、引入本地缓存等。</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>天天商城随记</div>
      <div>http://example.com/2025/03/09/天天商城随记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>presbyter</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月9日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/06/%E6%A0%A1%E5%9B%AD%E9%97%AA%E9%80%81%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="校园闪送项目笔记">
                        <span class="hidden-mobile">校园闪送项目笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
